<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Happy Birthday!</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(to bottom, #ffe6f2, #ffcce0);
      font-family: 'Comic Sans MS', cursive, sans-serif;
      color: #d147a3;
      text-align: center;
    }
    h1 { font-size: 2em; margin: 10px; }
    p { font-size: 1em; margin: 5px; }

    .cake {
      position: relative;
      width: 160px; height: 140px;
      background: radial-gradient(circle at 70% 30%, #ffd6eb, #fff 60%);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      margin: 20px auto;
    }
    .candle {
      position: absolute; top: -40px; left: 50%;
      width: 10px; height: 30px; background: #fff;
      border-radius: 5px; transform: translateX(-50%);
    }
    .flame {
      position: absolute; top: -20px; left: 50%;
      width: 15px; height: 15px;
      background: radial-gradient(circle, yellow, orange, red);
      border-radius: 50%; transform: translateX(-50%);
      animation: flicker 0.2s infinite alternate;
    }
    @keyframes flicker {
      from { transform: translateX(-50%) scale(1); opacity: 1; }
      to   { transform: translateX(-50%) scale(1.2); opacity: 0.8; }
    }

    .plate {
      width: 200px; height: 20px; background: #fff;
      border-radius: 50%; margin: auto; margin-top: -5px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    #startButton {
      margin-top: 20px; padding: 10px 20px; font-size: 1em;
      background: #ff66b2; border: none; border-radius: 8px;
      color: white; cursor: pointer;
    }
    #message {
      display: none; font-size: 1.3em; margin-top: 15px;
      text-shadow: 2px 2px 8px #ff6699;
    }
    #debug { font-size: 0.8em; color: gray; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üéâ Happy Birthday, Sis! üéÇ</h1>
  <p>Blow into your phone to put out the candle üé§</p>

  <div class="cake">
    <div class="candle">
      <div class="flame" id="flame"></div>
    </div>
  </div>
  <div class="plate"></div>

  <button id="startButton">Start the Magic ‚ú®</button>

  <div id="message">‚ù§Ô∏è  To my amazing little sister 
You‚Äôve grown into such a beautiful, kind, and brilliant person.
I‚Äôm so proud of you every single day.

May your year be filled with endless joy, success, and blessings.
Keep smiling, keep shining, and never stop being YOU. üåü

Today is all about celebrating you so eat lots of cake üç∞, laugh loudly üòÇ, and make the most magical memories ‚ú® ‚ù§Ô∏è WESTERNüëæ </div>
  <div id="debug"></div> <!-- volume debug -->

  <script>
    const flame = document.getElementById("flame");
    const message = document.getElementById("message");
    const startButton = document.getElementById("startButton");
    const debug = document.getElementById("debug");

    startButton.addEventListener("click", async () => {
      startButton.style.display = "none";
      try {
        // Unlock AudioContext on iPhone
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") {
          await audioCtx.resume();
        }

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const analyser = audioCtx.createAnalyser();
        const source = audioCtx.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        function detectBlow() {
          analyser.getByteFrequencyData(dataArray);
          let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
          debug.textContent = "Volume: " + volume.toFixed(2); // show live volume

          if (volume > 20) { // LOWER threshold for iPhone
            flame.style.display = "none";
            message.style.display = "block";
          } else {
            requestAnimationFrame(detectBlow);
          }
        }
        detectBlow();
      } catch (err) {
        alert("Microphone access is needed to blow out the candle!");
        console.error(err);
      }
    });
  </script>
</body>
</html>
